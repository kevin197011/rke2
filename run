#!/usr/bin/env ruby
# frozen_string_literal: true

# Copyright (c) 2025 Kk
#
# This software is released under the MIT License.
# https://opensource.org/licenses/MIT

require_relative 'lib/rke2'

# RKE2 Deployment CLI Tool
class RKE2CLI
  def initialize
    # Check for debug flags
    @debug_mode = ENV['DEBUG'] == '1' || ARGV.include?('--debug') || ARGV.include?('-d')

    # Initialize logger with appropriate level
    log_level = @debug_mode ? :debug : :info
    @logger = RKE2::Logger.new(level: log_level)
    @config_file = 'config.yml'

    return unless @debug_mode

    @logger.debug('Debug mode enabled')
    @logger.debug("Command line arguments: #{ARGV.inspect}")
  end

  # Main entry point
  def run
    show_banner

    if ARGV.length > 0
      handle_command_line_args
    else
      show_interactive_menu
    end
  end

  private

  # Show application banner
  def show_banner
    puts "\n" + '=' * 80
    puts "ğŸš€ RKE2 é›†ç¾¤éƒ¨ç½²å·¥å…· v#{RKE2::VERSION}"
    puts '=' * 80
    puts 'ğŸ“‹ é«˜å¯ç”¨ Kubernetes é›†ç¾¤è‡ªåŠ¨åŒ–éƒ¨ç½²'
    puts 'ğŸ”§ æ”¯æŒ HAProxy è´Ÿè½½å‡è¡¡ã€Server/Agent èŠ‚ç‚¹éƒ¨ç½²'
    puts 'âš¡ è‡ªåŠ¨é…ç½® kubectlã€Helmã€K9s å·¥å…·'
    puts "ğŸ› è°ƒè¯•æ¨¡å¼: #{@debug_mode ? 'å¼€å¯' : 'å…³é—­'}"
    puts '=' * 80
  end

  # Handle command line arguments
  def handle_command_line_args
    # Filter out debug flags
    commands = ARGV.reject { |arg| %w[--debug -d].include?(arg) }
    command = commands[0].to_s.downcase

    case command
    when 'deploy', 'run'
      run_full_deployment
    when 'quick'
      run_quick_deployment
    when 'ha'
      run_full_deployment # Same as full deployment
    when 'servers'
      run_servers_only
    when 'bootstrap', 'init'
      run_bootstrap_only_cli
    when 'help', '--help', '-h'
      show_help
    when 'version', '--version', '-v'
      puts "RKE2 éƒ¨ç½²å·¥å…· v#{RKE2::VERSION}"
      puts "Debug mode: #{@debug_mode ? 'enabled' : 'disabled'}" if @debug_mode
    else
      puts "âŒ æœªçŸ¥å‘½ä»¤: #{command}"
      puts "ğŸ’¡ ä½¿ç”¨ './run help' æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯"
      exit 1
    end
  end

  # Show interactive menu
  def show_interactive_menu
    loop do
      puts "\nğŸ“‹ è¯·é€‰æ‹©éƒ¨ç½²æ¨¡å¼:"
      puts '  1. ğŸ¢ å®Œæ•´éƒ¨ç½² (ç³»ç»Ÿåˆå§‹åŒ– + HAProxy + Server + Agent + é…ç½®å·¥å…·)'
      puts '  2. âš¡ å¿«é€Ÿéƒ¨ç½² (ä»… Server èŠ‚ç‚¹ + é…ç½®å·¥å…·)'
      puts '  3. ğŸ›ï¸  æœåŠ¡å™¨éƒ¨ç½² (ç³»ç»Ÿåˆå§‹åŒ– + HAProxy + Server + é…ç½®å·¥å…·)'
      puts '  4. ğŸ”§ è‡ªå®šä¹‰éƒ¨ç½² (é€‰æ‹©æ€§è·³è¿‡ç»„ä»¶)'
      puts '  5. ğŸš€ ç³»ç»Ÿåˆå§‹åŒ– (ä»…æ‰§è¡Œæ€§èƒ½ä¼˜åŒ–)'
      puts '  6. â„¹ï¸  é…ç½®ä¿¡æ¯é¢„è§ˆ'
      puts '  7. â“ å¸®åŠ©ä¿¡æ¯'
      puts '  0. ğŸšª é€€å‡º'

      print "\nè¯·è¾“å…¥é€‰é¡¹ (0-7): "
      choice = STDIN.gets&.chomp || '0'

      case choice
      when '1'
        run_full_deployment
        break
      when '2'
        run_quick_deployment
        break
      when '3'
        run_servers_only
        break
      when '4'
        run_custom_deployment
        break
      when '5'
        run_bootstrap_only
        break
      when '6'
        show_config_preview
      when '7'
        show_help
      when '0'
        puts 'ğŸ‘‹ æ„Ÿè°¢ä½¿ç”¨ RKE2 éƒ¨ç½²å·¥å…·ï¼'
        exit 0
      else
        puts 'âŒ æ— æ•ˆé€‰é¡¹ï¼Œè¯·è¾“å…¥ 0-7 ä¹‹é—´çš„æ•°å­—'
      end
    end
  end

  # Run full deployment
  def run_full_deployment
    puts "\nğŸ¢ å¼€å§‹å®Œæ•´éƒ¨ç½²..."
    confirm_deployment('å®Œæ•´éƒ¨ç½² (åŒ…å«ç³»ç»Ÿåˆå§‹åŒ–ã€HAProxyã€Serverã€Agent èŠ‚ç‚¹åŠå·¥å…·é…ç½®)')

    success = RKE2::Deploy.run_full_with_bootstrap(@config_file, logger: @logger)

    if success
      puts "\nğŸ‰ å®Œæ•´éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
      show_next_steps
    else
      puts "\nâŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ä¿¡æ¯"
      exit 1
    end
  end

  # Run quick deployment
  def run_quick_deployment
    puts "\nâš¡ å¼€å§‹å¿«é€Ÿéƒ¨ç½²..."
    confirm_deployment('å¿«é€Ÿéƒ¨ç½² (ä»… Server èŠ‚ç‚¹ï¼Œä¸å«ç³»ç»Ÿåˆå§‹åŒ–ã€HAProxy å’Œ Agent)')

    success = RKE2::Deploy.run_quick(@config_file, logger: @logger)

    if success
      puts "\nğŸ‰ å¿«é€Ÿéƒ¨ç½²æˆåŠŸå®Œæˆï¼"
      show_next_steps
    else
      puts "\nâŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ä¿¡æ¯"
      exit 1
    end
  end

  # Run servers only deployment
  def run_servers_only
    puts "\nğŸ›ï¸  å¼€å§‹æœåŠ¡å™¨éƒ¨ç½²..."
    confirm_deployment('æœåŠ¡å™¨éƒ¨ç½² (åŒ…å«ç³»ç»Ÿåˆå§‹åŒ–ã€HAProxy å’Œ Server èŠ‚ç‚¹ï¼Œä¸å« Agent)')

    success = RKE2::Deploy.run_servers_only(@config_file, logger: @logger)

    if success
      puts "\nğŸ‰ æœåŠ¡å™¨éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
      show_next_steps
    else
      puts "\nâŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ä¿¡æ¯"
      exit 1
    end
  end

  # Run custom deployment
  def run_custom_deployment
    puts "\nğŸ”§ è‡ªå®šä¹‰éƒ¨ç½²é€‰é¡¹:"

    print 'è·³è¿‡ç³»ç»Ÿåˆå§‹åŒ–? (y/N): '
    skip_bootstrap = (STDIN.gets&.chomp&.downcase || 'n') == 'y'

    print 'è·³è¿‡ HAProxy é…ç½®? (y/N): '
    skip_haproxy = (STDIN.gets&.chomp&.downcase || 'n') == 'y'

    print 'è·³è¿‡ Agent èŠ‚ç‚¹éƒ¨ç½²? (y/N): '
    skip_agents = (STDIN.gets&.chomp&.downcase || 'n') == 'y'

    print 'è·³è¿‡æœ€ç»ˆå·¥å…·é…ç½®? (y/N): '
    skip_finalization = (STDIN.gets&.chomp&.downcase || 'n') == 'y'

    auto_reboot = true
    unless skip_bootstrap
      print 'ç³»ç»Ÿåˆå§‹åŒ–åè‡ªåŠ¨é‡å¯? (Y/n): '
      auto_reboot = (STDIN.gets&.chomp&.downcase || 'y') != 'n'
    end

    # Display custom configuration
    puts "\nğŸ“‹ è‡ªå®šä¹‰é…ç½®æ‘˜è¦:"
    puts "  ç³»ç»Ÿåˆå§‹åŒ–: #{if skip_bootstrap
                       'è·³è¿‡'
                     else
                       "æ‰§è¡Œ#{auto_reboot ? ' (è‡ªåŠ¨é‡å¯)' : ' (æ‰‹åŠ¨é‡å¯)'}"
                     end}"
    puts "  HAProxy è´Ÿè½½å‡è¡¡: #{skip_haproxy ? 'è·³è¿‡' : 'éƒ¨ç½²'}"
    puts '  RKE2 Server: éƒ¨ç½²'
    puts "  RKE2 Agent: #{skip_agents ? 'è·³è¿‡' : 'éƒ¨ç½²'}"
    puts "  å·¥å…·é…ç½® (kubectl/Helm/K9s): #{skip_finalization ? 'è·³è¿‡' : 'é…ç½®'}"

    confirm_deployment('è‡ªå®šä¹‰éƒ¨ç½²')

    success = RKE2::Deploy.run(
      @config_file,
      logger: @logger,
      skip_bootstrap: skip_bootstrap,
      skip_haproxy: skip_haproxy,
      skip_agents: skip_agents,
      skip_finalization: skip_finalization,
      auto_reboot: auto_reboot
    )

    if success
      puts "\nğŸ‰ è‡ªå®šä¹‰éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
      show_next_steps
    else
      puts "\nâŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ä¿¡æ¯"
      exit 1
    end
  end

  # Run bootstrap only
  def run_bootstrap_only
    puts "\nğŸš€ å¼€å§‹ç³»ç»Ÿåˆå§‹åŒ–..."

    print 'åˆå§‹åŒ–åè‡ªåŠ¨é‡å¯? (Y/n): '
    auto_reboot = (STDIN.gets&.chomp&.downcase || 'y') != 'n'

    confirm_deployment("ç³»ç»Ÿåˆå§‹åŒ–å’Œæ€§èƒ½ä¼˜åŒ–#{auto_reboot ? ' (è‡ªåŠ¨é‡å¯)' : ' (æ‰‹åŠ¨é‡å¯)'}")

    success = RKE2::Deploy.run_bootstrap_only(@config_file, auto_reboot: auto_reboot, logger: @logger)

    if success
      puts "\nğŸ‰ ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸå®Œæˆï¼"
      if auto_reboot
        puts "\nğŸ’¡ åç»­æ“ä½œå»ºè®®:"
        puts '  1. ç³»ç»Ÿå·²ä¼˜åŒ–ï¼Œå¯ä»¥ç»§ç»­ RKE2 éƒ¨ç½²'
        puts '  2. è¿è¡Œ: ./run quick (å¿«é€Ÿéƒ¨ç½²)'
        puts '  3. æˆ–è¿è¡Œ: ./run deploy (å®Œæ•´éƒ¨ç½²ï¼Œä½†ä¼šè·³è¿‡å·²å®Œæˆçš„åˆå§‹åŒ–)'
      else
        puts "\nğŸ’¡ åç»­æ“ä½œå»ºè®®:"
        puts '  1. æ‰‹åŠ¨é‡å¯æ‰€æœ‰èŠ‚ç‚¹: sudo reboot'
        puts '  2. é‡å¯å®Œæˆåç»§ç»­ RKE2 éƒ¨ç½²'
      end
    else
      puts "\nâŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ä¿¡æ¯"
      exit 1
    end
  end

  # Run bootstrap only from command line
  def run_bootstrap_only_cli
    puts "\nğŸš€ å¼€å§‹ç³»ç»Ÿåˆå§‹åŒ–..."

    # Check for --no-reboot flag
    auto_reboot = !ARGV.include?('--no-reboot')

    confirm_deployment("ç³»ç»Ÿåˆå§‹åŒ–å’Œæ€§èƒ½ä¼˜åŒ–#{auto_reboot ? ' (è‡ªåŠ¨é‡å¯)' : ' (æ‰‹åŠ¨é‡å¯)'}")

    success = RKE2::Deploy.run_bootstrap_only(@config_file, auto_reboot: auto_reboot, logger: @logger)

    if success
      puts "\nğŸ‰ ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸå®Œæˆï¼"
      unless auto_reboot
        puts "\nğŸ’¡ åç»­æ“ä½œå»ºè®®:"
        puts '  1. æ‰‹åŠ¨é‡å¯æ‰€æœ‰èŠ‚ç‚¹: sudo reboot'
        puts '  2. é‡å¯å®Œæˆåç»§ç»­ RKE2 éƒ¨ç½²'
      end
    else
      puts "\nâŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ä¿¡æ¯"
      exit 1
    end
  end

  # Show configuration preview
  def show_config_preview
    puts "\nğŸ“‹ é…ç½®ä¿¡æ¯é¢„è§ˆ:"

    unless File.exist?(@config_file)
      puts "âŒ é…ç½®æ–‡ä»¶ #{@config_file} ä¸å­˜åœ¨"
      puts 'ğŸ’¡ è¯·å…ˆåˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œå‚è€ƒ config.yml.sample'
      return
    end

    begin
      config = RKE2::Config.load_config(@config_file)

      puts "\nğŸ”§ åŸºæœ¬é…ç½®:"
      puts "  Token: #{config['token'] || 'æœªè®¾ç½®'}"
      puts "  è´Ÿè½½å‡è¡¡å™¨ IP: #{config['loadbalancer_ip'] || 'æœªè®¾ç½®'}"
      puts "  SSH ç”¨æˆ·å: #{config['username'] || 'root'}"
      puts "  SSH å¯†é’¥: #{config['ssh_key'] || '~/.ssh/id_rsa'}"

      # Node information
      server_nodes = config['nodes'].select { |node| node['role'] == 'server' }
      agent_nodes = config['nodes'].select { |node| node['role'] == 'agent' }
      lb_nodes = config['nodes'].select { |node| node['role'] == 'lb' }

      puts "\nğŸ–¥ï¸  èŠ‚ç‚¹é…ç½®:"
      puts "  Server èŠ‚ç‚¹: #{server_nodes.length} ä¸ª"
      server_nodes.each do |node|
        puts "    - #{node['name']} (#{node['ip']})"
      end

      if agent_nodes.any?
        puts "  Agent èŠ‚ç‚¹: #{agent_nodes.length} ä¸ª"
        agent_nodes.each do |node|
          puts "    - #{node['name']} (#{node['ip']})"
        end
      end

      if lb_nodes.any?
        puts "  è´Ÿè½½å‡è¡¡å™¨: #{lb_nodes.length} ä¸ª"
        lb_nodes.each do |node|
          puts "    - #{node['name']} (#{node['ip']})"
        end
      end

      puts "\nğŸ“Š éƒ¨ç½²ç»Ÿè®¡:"
      puts "  æ€»èŠ‚ç‚¹æ•°: #{config['nodes'].length}"
      puts "  é¢„ä¼°éƒ¨ç½²æ—¶é—´: #{estimate_deployment_time(config['nodes'].length)}"
    rescue StandardError => e
      puts "âŒ é…ç½®æ–‡ä»¶è¯»å–å¤±è´¥: #{e.message}"
    end
  end

  # Show help information
  def show_help
    puts "\nğŸ“– RKE2 éƒ¨ç½²å·¥å…·ä½¿ç”¨å¸®åŠ©:"
    puts "\nğŸš€ å‘½ä»¤è¡Œä½¿ç”¨æ–¹å¼:"
    puts '  ./run                    # äº¤äº’å¼èœå•'
    puts '  ./run deploy             # å®Œæ•´éƒ¨ç½² (åŒ…å«ç³»ç»Ÿåˆå§‹åŒ–)'
    puts '  ./run quick              # å¿«é€Ÿéƒ¨ç½² (ä»… Server)'
    puts '  ./run ha                 # é«˜å¯ç”¨éƒ¨ç½² (ä¸ deploy ç›¸åŒ)'
    puts '  ./run servers            # æœåŠ¡å™¨éƒ¨ç½² (Server + HAProxy + åˆå§‹åŒ–)'
    puts '  ./run bootstrap          # ä»…ç³»ç»Ÿåˆå§‹åŒ–'
    puts '  ./run bootstrap --no-reboot  # ç³»ç»Ÿåˆå§‹åŒ– (ä¸è‡ªåŠ¨é‡å¯)'
    puts '  ./run help               # æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯'
    puts '  ./run version            # æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯'
    puts ''
    puts 'ğŸ› è°ƒè¯•é€‰é¡¹:'
    puts '  --debug, -d              # å¯ç”¨è¯¦ç»†è°ƒè¯•è¾“å‡º'
    puts '  DEBUG=1 ./run deploy     # é€šè¿‡ç¯å¢ƒå˜é‡å¯ç”¨è°ƒè¯•'

    puts "\nğŸ“‹ éƒ¨ç½²æ¨¡å¼è¯´æ˜:"
    puts '  ğŸ¢ å®Œæ•´éƒ¨ç½²: ç³»ç»Ÿåˆå§‹åŒ– + HAProxy + Server + Agent + å·¥å…·é…ç½®'
    puts '  âš¡ å¿«é€Ÿéƒ¨ç½²: ä»… Server èŠ‚ç‚¹ + å·¥å…·é…ç½®'
    puts '  ğŸ›ï¸  æœåŠ¡å™¨éƒ¨ç½²: ç³»ç»Ÿåˆå§‹åŒ– + HAProxy + Server + å·¥å…·é…ç½®'
    puts '  ğŸš€ ç³»ç»Ÿåˆå§‹åŒ–: æ€§èƒ½ä¼˜åŒ–ã€å†…æ ¸å‚æ•°è°ƒæ•´ã€é˜²ç«å¢™é…ç½®ç­‰'
    puts '  ğŸ”§ è‡ªå®šä¹‰éƒ¨ç½²: å¯é€‰æ‹©æ€§è·³è¿‡ç»„ä»¶'

    puts "\nğŸ“ é…ç½®æ–‡ä»¶ (config.yml) ç¤ºä¾‹:"
    puts '  token: rke2Secret123456'
    puts '  loadbalancer_ip: 192.168.1.100'
    puts '  username: devops'
    puts '  ssh_key: ~/.ssh/id_rsa'
    puts '  nodes:'
    puts '    - name: master-01'
    puts '      ip: 192.168.1.10'
    puts '      role: server'
    puts '    - name: worker-01'
    puts '      ip: 192.168.1.20'
    puts '      role: agent'
    puts '    - name: lb-01'
    puts '      ip: 192.168.1.100'
    puts '      role: lb'

    puts "\nğŸ’¡ éƒ¨ç½²æµç¨‹:"
    puts '  1. ğŸ” éªŒè¯é…ç½®å’ŒèŠ‚ç‚¹è¿æ¥'
    puts '  2. ğŸš€ ç³»ç»Ÿåˆå§‹åŒ–å’Œæ€§èƒ½ä¼˜åŒ– (å¦‚æœå¯ç”¨)'
    puts '  3. ğŸ”§ é…ç½® HAProxy è´Ÿè½½å‡è¡¡å™¨ (å¦‚æœå¯ç”¨)'
    puts '  4. ğŸ›ï¸  éƒ¨ç½² RKE2 Server èŠ‚ç‚¹'
    puts '  5. ğŸ‘¥ éƒ¨ç½² RKE2 Agent èŠ‚ç‚¹ (å¦‚æœå¯ç”¨)'
    puts '  6. âš™ï¸  é…ç½® kubectlã€Helmã€K9s (å¦‚æœå¯ç”¨)'
    puts '  7. âœ… éªŒè¯é›†ç¾¤çŠ¶æ€'

    puts "\nğŸš€ ç³»ç»Ÿåˆå§‹åŒ–åŒ…å«:"
    puts '  - æ—¶é—´åŒæ­¥é…ç½® (é¦™æ¸¯æ—¶åŒº)'
    puts '  - Swap ç¦ç”¨'
    puts '  - å†…æ ¸æ¨¡å—åŠ è½½ (overlay, br_netfilter ç­‰)'
    puts '  - ç³»ç»Ÿå‚æ•°ä¼˜åŒ– (ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿã€è™šæ‹Ÿå†…å­˜)'
    puts '  - ç³»ç»Ÿé™åˆ¶è°ƒæ•´ (æ–‡ä»¶å¥æŸ„ã€è¿›ç¨‹æ•°ç­‰)'
    puts '  - é˜²ç«å¢™é…ç½®'
    puts '  - å¿…è¦å·¥å…·å®‰è£…'
    puts '  - ç£ç›˜æ€§èƒ½ä¼˜åŒ–'
    puts '  - å†…å­˜ä¼˜åŒ– (ç¦ç”¨é€æ˜å¤§é¡µ)'

    puts "\nğŸ’¡ æ¨èéƒ¨ç½²æµç¨‹:"
    puts '  1. é¦–æ¬¡éƒ¨ç½²: ./run deploy (å®Œæ•´éƒ¨ç½²)'
    puts '  2. ä»…ç³»ç»Ÿä¼˜åŒ–: ./run bootstrap'
    puts '  3. æµ‹è¯•éƒ¨ç½²: ./run quick'
    puts '  4. ç”Ÿäº§ç¯å¢ƒ: ./run ha'

    puts "\nğŸ”— æ›´å¤šä¿¡æ¯:"
    puts '  é¡¹ç›®åœ°å€: https://github.com/your-repo/rke2-deploy'
    puts '  æ–‡æ¡£åœ°å€: https://docs.rke2.io/'
  end

  # Confirm deployment
  #
  # @param deployment_type [String] Type of deployment
  def confirm_deployment(deployment_type)
    puts "\nâš ï¸  ç¡®è®¤ä¿¡æ¯:"
    puts "  éƒ¨ç½²ç±»å‹: #{deployment_type}"
    puts "  é…ç½®æ–‡ä»¶: #{@config_file}"
    puts "  å½“å‰æ—¶é—´: #{Time.now.strftime('%Y-%m-%d %H:%M:%S')}"

    print "\nç¡®è®¤å¼€å§‹éƒ¨ç½²? (y/N): "
    confirm = STDIN.gets&.chomp&.downcase || 'n'

    return if %w[y yes].include?(confirm)

    puts 'âŒ ç”¨æˆ·å–æ¶ˆéƒ¨ç½²'
    exit 0
  end

  # Show next steps after successful deployment
  def show_next_steps
    puts "\nğŸ¯ åç»­æ“ä½œå»ºè®®:"
    puts '  1. SSH ç™»å½•åˆ°ä»»æ„ Server èŠ‚ç‚¹'
    puts '  2. éªŒè¯é›†ç¾¤çŠ¶æ€: kubectl get nodes'
    puts '  3. æŸ¥çœ‹ç®¡ç†è„šæœ¬: ls -la ~/cluster-*.sh ~/helm-*.sh'
    puts '  4. å¯åŠ¨ K9s ç®¡ç†ç•Œé¢: k9s'
    puts '  5. éƒ¨ç½²æµ‹è¯•åº”ç”¨: kubectl create deployment nginx --image=nginx'
  end

  # Estimate deployment time
  #
  # @param node_count [Integer] Number of nodes
  # @return [String] Estimated time
  def estimate_deployment_time(node_count)
    base_time = 5 # Base time in minutes
    per_node_time = 2 # Additional time per node

    total_minutes = base_time + (node_count * per_node_time)

    if total_minutes < 60
      "#{total_minutes} åˆ†é’Ÿ"
    else
      hours = total_minutes / 60
      minutes = total_minutes % 60
      "#{hours} å°æ—¶ #{minutes} åˆ†é’Ÿ"
    end
  end
end

# Main execution
if __FILE__ == $0
  begin
    cli = RKE2CLI.new
    cli.run
  rescue Interrupt
    puts "\n\nğŸ‘‹ ç”¨æˆ·ä¸­æ–­ï¼Œé€€å‡ºç¨‹åº"
    exit 130
  rescue StandardError => e
    puts "\nâŒ ç¨‹åºå¼‚å¸¸: #{e.message}"
    puts "ğŸ” è¯¦ç»†ä¿¡æ¯: #{e.backtrace.join("\n")}" if ENV['DEBUG']
    exit 1
  end
end
